<!DOCTYPE html>
<html>
  <head>
    <title>File Server</title>
    <style>
      #progressBar {
        width: 100%;
        height: 30px;
      }
    </style>
    <script>
      function uploadFile() {
        const fileInput = document.getElementById('fileInput');
        if (!fileInput.files.length) {
          alert('Please select a file first');
          return;
        }
        
        const file = fileInput.files[0];
        const formData = new FormData();
        formData.append('file', file);
        
        fetch('/upload', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            alert('Error: ' + data.error);
          } else {
            alert(data.message);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('An error occurred during upload');
        });
      }
      
      function downloadFile(filename) {
        if (!fileName) return;

        fetch('/download', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ filename: filename })
        })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            alert('Error: ' + data.error);
          } else {
            alert(data.message);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('An error occurred during download');
        });
      }
      
  function listFiles() {
    fetch('/list')
      .then(response => response.json())
      .then(data => {
        const fileList = document.getElementById('fileList');
        fileList.innerHTML = '';

        if (data.files && data.files.length) {
          const ul = document.createElement('ul');

          data.files.forEach(file => {
            if (file) { // Skip empty entries
              const li = document.createElement('li');
              li.classList.add('file-item');

              // Get the file extension (if any)
              const parts = file.split('.');
              const extension = parts.length > 1 ? parts.pop().toLowerCase() : '';

              // Icon mapping based on file extension
              const iconMapping = {
                'txt': 'icons/text-file.png',
                'pdf': 'icons/pdf-file.png',
                'doc': 'icons/word-file.png',
                'docx': 'icons/word-file.png',
                'xls': 'icons/excel-file.png',
                'xlsx': 'icons/excel-file.png',
                'png': 'icons/image-file.png',
                'jpg': 'icons/image-file.png',
                'jpeg': 'icons/image-file.png',
                'gif': 'icons/image-file.png'
                // Add more mappings as needed
              };

              const icon = document.createElement('img');
              icon.classList.add('file-icon');
              icon.src = iconMapping[extension] || 'icons/default-file.png';
              icon.alt = extension + ' file icon';

              const fileNameSpan = document.createElement('span');
              fileNameSpan.classList.add('file-name');
              fileNameSpan.textContent = file;

              const fileExtSpan = document.createElement('span');
              fileExtSpan.classList.add('file-extension');
              fileExtSpan.textContent = extension ? `.${extension}` : '';

              // Create the download button and attach onclick event
              const downloadButton = document.createElement('button');
              downloadButton.classList.add('download-button');
              downloadButton.textContent = 'Download';
              downloadButton.addEventListener('click', () => {
                downloadFile(file); // Pass the file name to the download function
              });

              li.appendChild(icon);
              li.appendChild(fileNameSpan);
              li.appendChild(fileExtSpan);
              li.appendChild(downloadButton);

              ul.appendChild(li);
            }
          });

          fileList.appendChild(ul);
        } else {
          fileList.textContent = 'No files available';
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while listing files');
      });
  }
    </script>
  </head>
  <body>
    <h1>File Server</h1>
    
    <div>
      <h2>Upload File</h2>
      <input type="file" id="fileInput">
      <button onclick="uploadFile()">Upload</button>
    </div>
    
    <div>
      <h2>Download File</h2>
      <button onclick="downloadFile()">Download</button>
    </div>
    
    <div>
      <h2>List Files</h2>
      <button onclick="listFiles()">List</button>
      <div id="fileList"></div>
    </div>
    <progress id="progressBar" value="0" max="100"></progress>
    <div id="progressText">0%</div>
    
    <script>
      const filename = 'default_file';  // Use the same key as in the Flask app

      // Function to fetch progress from the server
      function fetchProgress() {
        fetch(`/get_progress/${filename}`)
          .then(response => response.json())
          .then(data => {
            const progress = data.progress;
            document.getElementById('progressBar').value = progress;
            document.getElementById('progressText').innerText = `${progress}%`;
          })
          .catch(error => console.error('Error fetching progress:', error));
      }

      // Poll for progress updates every second
      setInterval(fetchProgress, 1000);
    </script>
  </body>
</html>